{% extends 'base.html' %} {% load custom_filters %} {% block content %}
<div class="container mt-4">
  <div
    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard Financeiro</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
      <a href="{% url 'finance_report' %}" class="btn btn-sm btn-outline-secondary">
        Relatorio
      </a>
      <a href="{% url 'contributions_list' %}" class="btn btn-sm btn-outline-secondary ms-2">
        Entradas
      </a>
      <a href="{% url 'expenses_list' %}" class="btn btn-sm btn-outline-secondary ms-2">
        Saidas
      </a>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label" for="period">Periodo</label>
          <select class="form-select" id="period" name="period">
            <option value="year" {% if period == "year" %}selected{% endif %}>Anual</option>
            <option value="month" {% if period == "month" %}selected{% endif %}>Mensal</option>
            <option value="range" {% if period == "range" %}selected{% endif %}>Periodo personalizado</option>
          </select>
        </div>
        <div class="col-md-3" id="year-field">
          <label class="form-label" for="year">Ano</label>
          <input type="number" class="form-control" id="year" name="year" value="{{ year }}"
            min="2000" max="2100" />
        </div>
        <div class="col-md-3 d-none" id="month-field">
          <label class="form-label" for="month">Mes</label>
          <input type="month" class="form-control" id="month" name="month" value="{{ month }}" />
        </div>
        <div class="col-md-3 d-none" id="start-field">
          <label class="form-label" for="start_date">Data inicial</label>
          <input type="date" class="form-control" id="start_date" name="start_date"
            value="{{ start_date }}" />
        </div>
        <div class="col-md-3 d-none" id="end-field">
          <label class="form-label" for="end_date">Data final</label>
          <input type="date" class="form-control" id="end_date" name="end_date"
            value="{{ end_date }}" />
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-primary w-100">Aplicar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted">Entradas (periodo)</div>
          <div class="fs-4">{{ total_entries|moeda_br }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted">Saidas (periodo)</div>
          <div class="fs-4">{{ total_exits|moeda_br }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted">Saldo (periodo)</div>
          <div class="fs-4">{{ balance|moeda_br }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">{{ chart_title }}</h5>
      <canvas id="financeChart" height="120"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const labels = {{ chart_labels| safe }};
  const entries = {{ chart_entries| safe }};
  const exits = {{ chart_exits| safe }};

  function formatCurrencyBR(value) {
    if (value === null || value === undefined || isNaN(value)) {
      return "R$ 0,00";
    }
    return `R$ ${Number(value).toFixed(2).replace(".", ",")}`;
  }

  const ctx = document.getElementById("financeChart");
  if (ctx) {
    new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Entradas",
            data: entries,
            borderColor: "#198754",
            backgroundColor: "rgba(25, 135, 84, 0.2)",
            tension: 0.3,
          },
          {
            label: "Saidas",
            data: exits,
            borderColor: "#dc3545",
            backgroundColor: "rgba(220, 53, 69, 0.2)",
            tension: 0.3,
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: function (context) {
                return `${context.dataset.label}: ${formatCurrencyBR(context.parsed.y)}`;
              },
            },
          },
        },
        scales: {
          y: {
            ticks: {
              callback: function (value) {
                return formatCurrencyBR(value);
              },
            },
          },
        },
      },
    });
  }
</script>
<script>
  const periodSelect = document.getElementById("period");
  const yearField = document.getElementById("year-field");
  const monthField = document.getElementById("month-field");
  const startField = document.getElementById("start-field");
  const endField = document.getElementById("end-field");

  function togglePeriodFields() {
    if (!periodSelect) {
      return;
    }
    if (periodSelect.value === "month") {
      monthField.classList.remove("d-none");
      yearField.classList.add("d-none");
      startField.classList.add("d-none");
      endField.classList.add("d-none");
      return;
    }
    if (periodSelect.value === "range") {
      monthField.classList.add("d-none");
      yearField.classList.add("d-none");
      startField.classList.remove("d-none");
      endField.classList.remove("d-none");
      return;
    }
    monthField.classList.add("d-none");
    yearField.classList.remove("d-none");
    startField.classList.add("d-none");
    endField.classList.add("d-none");
  }

  if (periodSelect) {
    periodSelect.addEventListener("change", togglePeriodFields);
    togglePeriodFields();
  }
</script>
{% endblock %}
