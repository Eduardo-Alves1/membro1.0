{% extends 'base.html' %} {% load widget_tweaks %} {% block content %}
<div class="container mt-4">
  <div
    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
  >
    <h1 class="h2">Adicionar Saida</h1>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" id="finance-form">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-8">
            <label class="form-label">{{ form.description.label }}</label>
            {% render_field form.description class="form-control" %}
          </div>
          <div class="col-md-4">
            <label class="form-label">{{ form.category.label }}</label>
            {% render_field form.category class="form-select" %}
          </div>
          <div class="col-md-4">
            <label class="form-label">{{ form.value.label }}</label>
            <div class="input-group">
              <span class="input-group-text">R$</span>
              {% render_field form.value class="form-control currency-input" id="id_value" placeholder="0,00" type="text" inputmode="decimal" %}
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">{{ form.date.label }}</label>
            {% render_field form.date class="form-control" %}
          </div>
          <div class="col-md-4">
            <label class="form-label">{{ form.payment_method.label }}</label>
            {% render_field form.payment_method class="form-select" %}
          </div>
          <div class="col-12">
            <label class="form-label">{{ form.notes.label }}</label>
            {% render_field form.notes class="form-control" rows="3" %}
          </div>
        </div>

        <hr class="my-4" />

        <button class="w-100 btn btn-primary btn-lg" type="submit">
          Salvar Saida
        </button>
      </form>
    </div>
  </div>
</div>
{% endblock %}
{% block javascript %}
<script>
  function formatCurrencyInput(value) {
    const digits = value.replace(/\D/g, "");
    if (!digits) {
      return "";
    }
    const number = (parseInt(digits, 10) / 100).toFixed(2);
    const parts = number.split(".");
    const integer = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return `${integer},${parts[1]}`;
  }

  function normalizeCurrencyValue(value) {
    if (!value) {
      return "";
    }
    return value.replace(/\./g, "").replace(",", ".");
  }

  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("finance-form");
    const inputs = document.querySelectorAll(".currency-input");
    if (!inputs.length) {
      return;
    }
    inputs.forEach((input) => {
      input.addEventListener("input", function () {
        this.value = formatCurrencyInput(this.value);
      });
      if (input.value) {
        input.value = formatCurrencyInput(input.value);
      }
    });
    if (form) {
      form.addEventListener("submit", function () {
        inputs.forEach((input) => {
          input.value = normalizeCurrencyValue(input.value);
        });
      });
    }
  });
</script>
{% endblock %}
