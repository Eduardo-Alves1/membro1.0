{% extends 'base.html' %} {% load widget_tweaks %} {% block content %}
<div class="container mt-4">
  <div
    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
  >
    <h1 class="h2">Editar Membro</h1>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}
        {% if form.errors %}
        <div class="alert alert-danger">
          <strong>Corrija os campos destacados.</strong>
          <div class="small mt-2">{{ form.errors }}</div>
        </div>
        {% endif %}
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">{{ form.name.label }}</label>
            {% render_field form.name class="form-control" %}
          </div>

          <div class="col-md-6">
            <label class="form-label">{{ form.cpf.label }}</label>
            {% render_field form.cpf class="form-control" %}
          </div>

          <div class="col-md-6">
            <label class="form-label">{{ form.telephone.label }}</label>
            {% render_field form.telephone class="form-control" %}
          </div>

          <div class="col-md-4">
            <label class="form-label">{{ form.date_birth.label }}</label>
            {% render_field form.date_birth type="date" class="form-control" %}
          </div>

          <div class="col-md-6">
            <label class="form-label">{{ form.address.label }}</label>
            {% render_field form.address class="form-control" id="id_address" %}
          </div>

          <div class="col-md-2">
            <label class="form-label">Numero da residencia</label>
            {% render_field form.address_number class="form-control" id="id_address_number" %}
          </div>

          <div class="col-md-4">
            <label class="form-label">{{ form.bairro.label }}</label>
            {% render_field form.bairro class="form-control" id="id_bairro" %}
          </div>

          <div class="col-md-2">
            <label class="form-label">{{ form.cep.label }}</label>
            {% render_field form.cep class="form-control" id="id_cep" %}
            <span id="cep-status" class="form-text"></span>
          </div>

          <div class="col-md-6">
            <label class="form-label">{{ form.state.label }}</label>
            {% render_field form.state class="form-control" id="id_state" %}
          </div>

          <div class="col-md-6">
            <label class="form-label">{{ form.city.label }}</label>
            {% render_field form.city class="form-control" id="id_city" %}
          </div>

          <div class="col-12">
            <div class="form-check mt-2">
              <input
                class="form-check-input"
                type="checkbox"
                id="id_same_birth_address"
              />
              <label class="form-check-label" for="id_same_birth_address">
                Esse endereco e o mesmo de nascimento?
              </label>
            </div>
          </div>

          <div class="col-12">
            <div id="birth-address-section" class="border rounded p-3 d-none">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Endereco de Nascimento</h5>
              </div>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">{{ form.birth_address.label }}</label>
                  {% render_field form.birth_address class="form-control" id="id_birth_address" %}
                </div>

                <div class="col-md-2">
                  <label class="form-label">Numero do endereco de nascimento</label>
                  {% render_field form.birth_address_number class="form-control" id="id_birth_address_number" %}
                </div>

                <div class="col-md-4">
                  <label class="form-label">{{ form.birth_bairro.label }}</label>
                  {% render_field form.birth_bairro class="form-control" id="id_birth_bairro" %}
                </div>

                <div class="col-md-2">
                  <label class="form-label">{{ form.birth_cep.label }}</label>
                  {% render_field form.birth_cep class="form-control" id="id_birth_cep" %}
                  <span id="birth-cep-status" class="form-text"></span>
                </div>

                <div class="col-md-5">
                  <label class="form-label">{{ form.city_birth.label }}</label>
                  {% render_field form.city_birth class="form-control" id="id_birth_city" %}
                </div>

                <div class="col-md-5">
                  <label class="form-label">{{ form.state_birth.label }}</label>
                  {% render_field form.state_birth class="form-control" id="id_birth_state" %}
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">{{ form.date_baptism.label }}</label>
            {% render_field form.date_baptism type="date" class="form-control" %}
          </div>

          <div class="col-md-6 align-self-center">
            <div class="form-check form-switch">
              {% render_field form.dizimista class="form-check-input" %}
              <label class="form-check-label">{{ form.dizimista.label }}</label>
            </div>
          </div>
        </div>

        <hr class="my-4" />

        <button type="submit" class="w-100 btn btn-primary btn-lg">
          Atualizar
        </button>
        <a href="{% url 'members_list' %}" class="w-100 btn btn-secondary mt-2"
          >Cancelar</a
        >
      </form>
    </div>
  </div>
</div>

{% block javascript %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const cepInput = document.getElementById("id_cep");
    const statusSpan = document.getElementById("cep-status");
    const birthCepInput = document.getElementById("id_birth_cep");
    const birthStatusSpan = document.getElementById("birth-cep-status");
    const sameBirthCheckbox = document.getElementById("id_same_birth_address");
    const birthSection = document.getElementById("birth-address-section");

    const residenceFields = {
      address: document.getElementById("id_address"),
      number: document.getElementById("id_address_number"),
      bairro: document.getElementById("id_bairro"),
      cep: document.getElementById("id_cep"),
      city: document.getElementById("id_city"),
      state: document.getElementById("id_state"),
    };

    const birthFields = {
      address: document.getElementById("id_birth_address"),
      number: document.getElementById("id_birth_address_number"),
      bairro: document.getElementById("id_birth_bairro"),
      cep: document.getElementById("id_birth_cep"),
      city: document.getElementById("id_birth_city"),
      state: document.getElementById("id_birth_state"),
    };

    function isBirthSameAsResidence() {
      return (
        birthFields.address.value === residenceFields.address.value &&
        birthFields.number.value === residenceFields.number.value &&
        birthFields.bairro.value === residenceFields.bairro.value &&
        birthFields.cep.value === residenceFields.cep.value &&
        birthFields.city.value === residenceFields.city.value &&
        birthFields.state.value === residenceFields.state.value
      );
    }

    function hasBirthData() {
      return Object.values(birthFields).some(
        (field) => field && field.value && field.value.trim() !== ""
      );
    }

    function syncBirthFromResidence() {
      if (!sameBirthCheckbox.checked) {
        return;
      }
      birthFields.address.value = residenceFields.address.value || "";
      birthFields.number.value = residenceFields.number.value || "";
      birthFields.bairro.value = residenceFields.bairro.value || "";
      birthFields.cep.value = residenceFields.cep.value || "";
      birthFields.city.value = residenceFields.city.value || "";
      birthFields.state.value = residenceFields.state.value || "";
    }

    function toggleBirthSection() {
      if (sameBirthCheckbox.checked) {
        birthSection.classList.add("d-none");
        syncBirthFromResidence();
      } else {
        birthSection.classList.remove("d-none");
      }
    }

    function bindCepLookup(input, status, map) {
      if (!input || !status) {
        return;
      }
      input.addEventListener("blur", function () {
        const cep = this.value.replace(/\D/g, "");
        status.textContent = "";
        status.className = "form-text";

        if (cep.length === 8) {
          status.textContent = "Buscando...";
          status.classList.add("text-muted");

          fetch(`/api/get-address/${cep}/`)
            .then((response) => {
              if (!response.ok) {
                return response.json().then((err) => {
                  throw new Error(err.error || "Erro de comunicaÃ§Ã£o.");
                });
              }
              return response.json();
            })
            .then((data) => {
              if (data.error) {
                throw new Error(data.error);
              }

              map.address.value = data.address;
              map.bairro.value = data.bairro;
              map.state.value = data.state;
              map.city.value = data.city;
              status.textContent = "EndereÃ§o preenchido!";
              status.className = "form-text text-success";

              if (sameBirthCheckbox.checked) {
                syncBirthFromResidence();
              }
            })
            .catch((error) => {
              console.error("Erro na busca de CEP:", error);
              status.textContent = error.message || "CEP nÃ£o encontrado.";
              status.className = "form-text text-danger";
            });
        }
      });
    }

    if (sameBirthCheckbox) {
      sameBirthCheckbox.checked = hasBirthData()
        ? isBirthSameAsResidence()
        : true;
      sameBirthCheckbox.addEventListener("change", toggleBirthSection);
    }

    Object.values(residenceFields).forEach((field) => {
      if (field) {
        field.addEventListener("input", syncBirthFromResidence);
      }
    });

    bindCepLookup(cepInput, statusSpan, residenceFields);
    bindCepLookup(birthCepInput, birthStatusSpan, birthFields);
    toggleBirthSection();
  });
</script>
{% endblock javascript %} {% endblock content %}
